<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="users">
    <resultMap type="com.jindata.restserver.apis.beans.User" id="ResultMapUsers">
      <id column="userno" jdbcType="BIGINT" property="userno"/>
      <collection property="groups" column="userno" ofType="com.jindata.apiserver.service.dto.Group" select="SelectGroupByPK"/>
      <collection property="roles" column="userno" ofType="com.jindata.apiserver.service.dto.Role" select="SelectRoleByPK"/>
      <collection property="roletargets" column="userno" ofType="com.jindata.apiserver.service.dto.Roletarget" select="SelectRoletargetByPK"/>
    </resultMap>
    <select id="userList" resultType="com.jindata.restserver.apis.beans.User">
      select 
        userno, username, email, password, isdeleted 
      from users 
      where isdeleted='N'
      order by 
      <choose>
        <when test="userno != null">userno</when>
        <when test="name != null">name</when>
        <otherwise>userno</otherwise>
      </choose>
      <choose>
        <when test="isasc == 1">asc</when>
        <otherwise>desc</otherwise>
      </choose>
      limit (#{pageno}-1) * #{maxPageCnt}, #{pageno}
    </select>
    <select id="SelectUserByPK" resultMap="ResultMapUsers">
      select userno, username, email, password, isdeleted from users where userno = #{userno,jdbcType=BIGINT} and isdeleted='N'
    </select>
    <insert id="userCreate" parameterType="com.jindata.restserver.apis.beans.User" flushCache="true" statementType="PREPARED">
        insert into users (username,password,email,isdeleted) 
        values (#{username,javaType=String,jdbcType=VARCHAR},#{password,javaType=String,jdbcType=VARCHAR},#{email,javaType=String,jdbcType=VARCHAR},'N')
    </insert>    
    <update id="userUpdate">
        update users
        <set>
          <if test="username!=null">username = #{username}</if>
          <if test="password!=null">password = #{password}</if>
          <if test="email!=null">email = #{email}</if>
        </set>
        WHERE userno=#{userno} and isdeleted='N'
    </update>
    
    <delete id="userDelete">
      UPDATE users SET isdeleted = 'Y' WHERE userno=#{userno}
    </delete>
    
    <select id="SelectGroupByPK" resultType="com.jindata.restserver.apis.beans.Group">
        select groupno, name, description from groups WHERE groupno in (SELECT groupno FROM group_user WHERE userno = #{userno,jdbcType=BIGINT})
    </select>
    <select id="SelectRoleByPK" resultType="com.jindata.restserver.apis.beans.Role">
        select roleno, name, description from roles WHERE groupno in (SELECT groupno FROM group_user WHERE userno = #{userno,jdbcType=BIGINT})
    </select>
    <select id="SelectRoletargetByPK" resultType="com.jindata.restserver.apis.beans.Roletarget">
        SELECT * 
        FROM role_target WHERE roleno in (SELECT roleno FROM role_user WHERE userno=#{userno,jdbcType=BIGINT})
    </select>
    
    <select id="userInfoByEmail" parameterType="map" resultType="map">
      select userno, username, email, password from users where email = #{email} and isdeleted='N'
    </select>
    
    <select id="userLogin" parameterType="map" resultType="com.jindata.restserver.apis.beans.User" resultMap="ResultMapUsers">
      select *
      from users 
      where email=#{email,jdbcType=VARCHAR} and password=#{password,jdbcType=VARCHAR} and isdeleted='N' AND isEmailAuth='Y'
    </select>
    
    <select id="getInfoByuserno" parameterType="map" resultType="com.jindata.restserver.apis.beans.User" resultMap="ResultMapUsers">
      select *
      from users 
      where userno=#{userno,jdbcType=BIGINT} and isdeleted='N' AND isEmailAuth='Y'
    </select>
    
    <update id="postLogin">
      UPDATE users SET lastLogin=CURRENT_TIMESTAMP WHERE userno=#{userno}
    </update>
    
    <update id="postEmailAuth">
      UPDATE users SET isEmailAuth='Y' WHERE userno=#{userno}
    </update>
</mapper>
<!-- 
USERNO INT GENERATED BY DEFAULT AS IDENTITY 
          (START WITH 1, INCREMENT BY 1) NOT NULL,
    USERID VARCHAR(45) NOT NULL,
	USERNAME VARCHAR(45) NOT NULL,
	PASSWORD VARCHAR(45) NOT NULL,
 -->